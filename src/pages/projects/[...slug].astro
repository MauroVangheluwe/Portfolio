---
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import ProjectLayout from "../../layouts/ProjectLayout.astro";
import Footer from "../../components/Footer.astro";

export async function getStaticPaths() {
  const projects: CollectionEntry<"projects">[] =
    await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props as { project: CollectionEntry<"projects"> };

const { Content } = await render(project);
const {
  name,
  creativeField,
  duration,
  year,
  client,
  software,
  imgs: rawImgs,
  websiteImgIndexes,
  iframes,
  iframeIndexes,
} = project.data;

// Import all videos from content/projects/images using Vite's glob import
const videos = import.meta.glob(
  "/src/content/projects/images/**/*.{mp4,webm}",
  {
    eager: true,
    query: "?url",
    import: "default",
  }
);

// Process imgs to handle videos - replace relative paths with actual imported URLs
const imgs = rawImgs
  ? await Promise.all(
      rawImgs.map(async (img) => {
        if (
          typeof img === "string" &&
          (img.includes(".mp4") || img.includes(".webm"))
        ) {
          // Convert relative path to absolute import path for lookup
          const videoPath = img.replace(
            "./images/",
            `/src/content/projects/images/`
          );
          // Find the matching video import
          const videoUrl = videos[videoPath];
          if (videoUrl) {
            return videoUrl as string;
          }
          console.warn(`Video not found in imports: ${videoPath}`);
          return img; // Fallback to original path
        }
        return img;
      })
    )
  : [];

// Render the description content to HTML string
const { body } = project;
---

<ProjectLayout
  title={project.data.name}
  projectName={name}
  projectDescription={Content}
  creativeField={creativeField}
  duration={duration}
  year={year}
  client={client}
  software={software}
>
  <!-- Loading Animation -->
  <div id="project-loader" class="project-loader">
    <div class="loader-content">
      <div class="spinner"></div>
      <p class="loader-text">Loading project...</p>
    </div>
  </div>

  {
    imgs && imgs.length > 0 && (
      <div
        class="gallery"
        id="gallery"
        data-image-count={imgs.length}
        style="opacity: 0;"
      >
        {imgs.map((imgSrc, index) => {
          const isIframePlaceholder = imgSrc === "IFRAME_PLACEHOLDER";
          const isIframeIndex = iframeIndexes?.includes(index);

          if (isIframePlaceholder || isIframeIndex) {
            const iframeData = iframes?.[iframeIndexes?.indexOf(index) ?? 0];
            if (!iframeData) return null;

            return (
              <iframe
                src={iframeData.src}
                width={iframeData.width || 1200}
                height={iframeData.height || 675}
                class="gallery-item gallery-iframe"
                data-is-website="false"
                allowfullscreen
                style="border: 1px solid rgba(19, 147, 209, 0.3);"
              />
            );
          }

          if (typeof imgSrc === "string") {
            const isVideo = imgSrc.includes(".mp4") || imgSrc.includes(".webm");

            if (isVideo) {
              return (
                <video
                  autoplay
                  loop
                  muted
                  playsinline
                  preload="auto"
                  class="gallery-item"
                  data-media-index={index}
                  data-is-website={
                    websiteImgIndexes?.includes(index) ? "true" : "false"
                  }
                  onloadstart="this.play().catch(e => console.log('Video autoplay prevented:', e))"
                >
                  <source
                    src={imgSrc}
                    type={imgSrc.includes(".webm") ? "video/webm" : "video/mp4"}
                  />
                  Your browser does not support the video tag.
                </video>
              );
            }

            // String but not a video - skip
            return null;
          }

          return (
            <Image
              src={imgSrc}
              alt={`${name} - Image ${index + 1}`}
              class="gallery-item"
              data-media-index={index}
              data-is-website={
                websiteImgIndexes?.includes(index) ? "true" : "false"
              }
              widths={[400, 640, 1024, 1280, 1920]}
              sizes="(min-width: 64rem) 1280px, (min-width: 48rem) 1024px, (min-width: 40rem) 640px, 400px"
              format="webp"
              loading="lazy"
            />
          );
        })}
      </div>
    )
  }
</ProjectLayout>

<style>
  .project-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background-color: var(--color-blue-dark);
    background-image: radial-gradient(
      circle,
      var(--color-blue-light) 1px,
      transparent 1px
    );
    background-size: 50px 50px;
    background-position:
      0 0,
      25px 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition:
      opacity 0.5s ease,
      visibility 0.5s ease;
    overflow: hidden;
  }

  .project-loader.loaded {
    opacity: 0;
    visibility: hidden;
  }

  :global(body.loading) {
    overflow: hidden !important;
    height: 100vh;
    position: fixed;
    width: 100%;
  }

  .loader-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .spinner {
    width: 6rem;
    height: 6rem;
    border: 0.4rem solid var(--color-blue);
    border-top-color: var(--color-blue-light);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .loader-text {
    font-family: "Owners-XXNarrow", sans-serif;
    font-size: 3rem;
    color: var(--color-blue-light);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>

<script>
  // Disable scrolling immediately
  document.body.classList.add("loading");

  document.addEventListener("DOMContentLoaded", () => {
    const loader = document.getElementById("project-loader");
    const gallery = document.getElementById("gallery");

    if (!gallery || !loader) {
      document.body.classList.remove("loading");
      return;
    }

    // Get all images and videos in the gallery
    const images = Array.from(gallery.querySelectorAll("img"));
    const videos = Array.from(gallery.querySelectorAll("video"));
    const iframes = Array.from(gallery.querySelectorAll("iframe"));

    const maxLoadTime = 2000; // Maximum 2 seconds total

    // Always hide loader after max time, regardless of load status
    setTimeout(() => {
      hideLoader();
    }, maxLoadTime);

    function hideLoader() {
      // Wait for gallery to be marked as ready (layout complete)
      let attempts = 0;
      const maxAttempts = 20; // 1 second max (20 * 50ms)

      const checkGalleryReady = () => {
        attempts++;

        if (
          (gallery && gallery.classList.contains("ready")) ||
          attempts >= maxAttempts
        ) {
          if (attempts >= maxAttempts) {
            console.warn("Gallery ready timeout - forcing loader hide");
          }

          if (loader) {
            loader.classList.add("loaded");
          }
          if (gallery) {
            gallery.style.opacity = "1";
            gallery.style.transition = "opacity 0.5s ease";
          }
          // Re-enable scrolling
          document.body.classList.remove("loading");
        } else {
          // Check again in 50ms
          setTimeout(checkGalleryReady, 50);
        }
      };

      checkGalleryReady();
    }
  });
</script>
