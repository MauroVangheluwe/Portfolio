---
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import ProjectLayout from "../../layouts/ProjectLayout.astro";

export async function getStaticPaths() {
  const projects: CollectionEntry<"projects">[] =
    await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props as { project: CollectionEntry<"projects"> };

const { Content } = await render(project);
const {
  name,
  creativeField,
  duration,
  year,
  client,
  software,
  imgs,
  websiteImgIndexes,
  iframes,
  iframeIndexes,
} = project.data;

// Render the description content to HTML string
const { body } = project;
---

<ProjectLayout
  title={project.data.name}
  projectName={name}
  projectDescription={Content}
  creativeField={creativeField}
  duration={duration}
  year={year}
  client={client}
  software={software}
>
  {
    imgs && imgs.length > 0 && (
      <div class="gallery" id="gallery" data-image-count={imgs.length}>
        {imgs.map((imgSrc, index) => {
          const isIframePlaceholder = imgSrc === "IFRAME_PLACEHOLDER";
          const isIframeIndex = iframeIndexes?.includes(index);

          if (isIframePlaceholder || isIframeIndex) {
            const iframeData = iframes?.[iframeIndexes?.indexOf(index) ?? 0];
            if (!iframeData) return null;

            return (
              <iframe
                src={iframeData.src}
                width={iframeData.width || 1200}
                height={iframeData.height || 675}
                class="gallery-item gallery-iframe"
                data-is-website="false"
                allowfullscreen
                style="border: 1px solid rgba(19, 147, 209, 0.3);"
              />
            );
          }

          // Check if it's a GIF (keep as img tag for animation)
          // Check both .src string and .format property for GIF detection
          const isGif =
            (typeof imgSrc === "object" &&
              imgSrc.src &&
              typeof imgSrc.src === "string" &&
              imgSrc.src.endsWith(".gif")) ||
            (typeof imgSrc === "object" && imgSrc.format === "gif");

          if (isGif) {
            return (
              <img
                src={imgSrc.src}
                alt={`${name} - Image ${index + 1}`}
                class="gallery-item"
                data-is-website={
                  websiteImgIndexes?.includes(index) ? "true" : "false"
                }
                loading="lazy"
              />
            );
          }

          return (
            <Image
              src={imgSrc}
              alt={`${name} - Image ${index + 1}`}
              class="gallery-item"
              data-is-website={
                websiteImgIndexes?.includes(index) ? "true" : "false"
              }
              widths={[400, 640, 1024, 1280, 1920]}
              sizes="(min-width: 64rem) 1280px, (min-width: 48rem) 1024px, (min-width: 40rem) 640px, 400px"
              format="webp"
              loading="lazy"
            />
          );
        })}
      </div>
    )
  }
</ProjectLayout>
