---
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import ProjectLayout from "../../layouts/ProjectLayout.astro";

export async function getStaticPaths() {
  const projects: CollectionEntry<"projects">[] =
    await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props as { project: CollectionEntry<"projects"> };

const { Content } = await render(project);
const {
  name,
  creativeField,
  duration,
  year,
  client,
  software,
  imgs: rawImgs,
  websiteImgIndexes,
  iframes,
  iframeIndexes,
} = project.data;

// Import all videos from content/projects/images using Vite's glob import
const videos = import.meta.glob(
  "/src/content/projects/images/**/*.{mp4,webm}",
  {
    eager: true,
    query: "?url",
    import: "default",
  }
);

// Process imgs to handle videos - replace relative paths with actual imported URLs
const imgs = rawImgs
  ? await Promise.all(
      rawImgs.map(async (img) => {
        if (
          typeof img === "string" &&
          (img.includes(".mp4") || img.includes(".webm"))
        ) {
          // Convert relative path to absolute import path for lookup
          const videoPath = img.replace(
            "./images/",
            `/src/content/projects/images/`
          );
          // Find the matching video import
          const videoUrl = videos[videoPath];
          if (videoUrl) {
            return videoUrl as string;
          }
          console.warn(`Video not found in imports: ${videoPath}`);
          return img; // Fallback to original path
        }
        return img;
      })
    )
  : [];

// Render the description content to HTML string
const { body } = project;
---

<ProjectLayout
  title={project.data.name}
  projectName={name}
  projectDescription={Content}
  creativeField={creativeField}
  duration={duration}
  year={year}
  client={client}
  software={software}
>
  {
    imgs && imgs.length > 0 && (
      <div class="gallery" id="gallery" data-image-count={imgs.length}>
        {imgs.map((imgSrc, index) => {
          const isIframePlaceholder = imgSrc === "IFRAME_PLACEHOLDER";
          const isIframeIndex = iframeIndexes?.includes(index);

          if (isIframePlaceholder || isIframeIndex) {
            const iframeData = iframes?.[iframeIndexes?.indexOf(index) ?? 0];
            if (!iframeData) return null;

            return (
              <iframe
                src={iframeData.src}
                width={iframeData.width || 1200}
                height={iframeData.height || 675}
                class="gallery-item gallery-iframe"
                data-is-website="false"
                allowfullscreen
                style="border: 1px solid rgba(19, 147, 209, 0.3);"
              />
            );
          }

          // Check if it's a video (MP4, WebM) - these are now imported URLs as strings
          if (typeof imgSrc === "string") {
            const isVideo = imgSrc.includes(".mp4") || imgSrc.includes(".webm");

            if (isVideo) {
              // The video path is already processed with ?url import, so use it directly
              return (
                <video
                  autoplay
                  loop
                  muted
                  playsinline
                  class="gallery-item"
                  data-is-website={
                    websiteImgIndexes?.includes(index) ? "true" : "false"
                  }
                >
                  <source
                    src={imgSrc}
                    type={imgSrc.includes(".webm") ? "video/webm" : "video/mp4"}
                  />
                </video>
              );
            }

            // String but not a video - skip
            return null;
          }

          // If we get here, it's an image object
          return (
            <Image
              src={imgSrc}
              alt={`${name} - Image ${index + 1}`}
              class="gallery-item"
              data-is-website={
                websiteImgIndexes?.includes(index) ? "true" : "false"
              }
              widths={[400, 640, 1024, 1280, 1920]}
              sizes="(min-width: 64rem) 1280px, (min-width: 48rem) 1024px, (min-width: 40rem) 640px, 400px"
              format="webp"
              loading="lazy"
            />
          );
        })}
      </div>
    )
  }
</ProjectLayout>
